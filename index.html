<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â§úÂ∏ÇÈ∫ªÂ∞áË≥ìÊûú</title>
    
    <!-- 1. ËºâÂÖ• Tailwind CSS (ËôïÁêÜÊ®£Âºè) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ËºâÂÖ• React Âíå ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. ËºâÂÖ• Babel (ËÆìÁÄèË¶ΩÂô®ÁúãÂæóÊáÇ JSX Ë™ûÊ≥ï) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Èö±ËóèÊç≤Ëª∏‰ΩÜ‰øùÁïôÂäüËÉΩ */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-black select-none">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ÂÖßÂª∫ÂúñÊ®ô (Âèñ‰ª£ Lucide-React ‰æùË≥¥) ---
        const PlayIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>
        );
        const GiftIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></svg>
        );
        const AlertCircleIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        );
        const GripHorizontalIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="9" r="1"/><circle cx="19" cy="9" r="1"/><circle cx="5" cy="9" r="1"/><circle cx="12" cy="15" r="1"/><circle cx="19" cy="15" r="1"/><circle cx="5" cy="15" r="1"/></svg>
        );

        // --- ÈÅäÊà≤Ë®≠ÂÆöËàáË≥áÊñô ---
        const BOARD_SIZE = 6;
        const INITIAL_DRAW_COUNT = 15;
        const EXTRA_DRAW_COUNT = 3;

        const TILES = {
            '1m': 'üÄá', '2m': 'üÄà', '3m': 'üÄâ', '4m': 'üÄä', '5m': 'üÄã', '6m': 'üÄå', '7m': 'üÄç', '8m': 'üÄé', '9m': 'üÄè',
            '1s': 'üÄê', '2s': 'üÄë', '3s': 'üÄí', '4s': 'üÄì', '5s': 'üÄî', '6s': 'üÄï', '7s': 'üÄñ', '8s': 'üÄó', '9s': 'üÄò',
            '1p': 'üÄô', '2p': 'üÄö', '3p': 'üÄõ', '4p': 'üÄú', '5p': 'üÄù', '6p': 'üÄû', '7p': 'üÄü', '8p': 'üÄ†', '9p': 'üÄ°',
            'east': 'üÄÄ', 'south': 'üÄÅ', 'west': 'üÄÇ', 'north': 'üÄÉ',
            'red': 'üÄÑ', 'green': 'üÄÖ', 'white': 'üÄÜ',
            'f1': 'üÄ¢', 'f2': 'üÄ£', 'f3': 'üÄ§', 'f4': 'üÄ•', 'f5': 'üÄ¶', 'f6': 'üÄß', 'f7': 'üÄ®', 'f8': 'üÄ©',
        };

        const TILE_KEYS = Object.keys(TILES);

        const getTileColor = (key) => {
            if (key.includes('m')) return 'text-red-600';
            if (key.includes('s')) return 'text-green-700';
            if (key.includes('p')) return 'text-blue-600';
            if (key.includes('f')) return 'text-pink-600';
            return 'text-black';
        };

        const getUniqueGameTiles = () => {
            const allKeys = [...TILE_KEYS];
            for (let i = allKeys.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allKeys[i], allKeys[j]] = [allKeys[j], allKeys[i]];
            }
            return allKeys.slice(0, BOARD_SIZE * BOARD_SIZE);
        };

        const checkWin = (board) => {
            const size = BOARD_SIZE;
            let winningIndices = new Set();
            let maxLineCount = 0;
            let hasWin = false;
            const lines = [];

            // Rows & Cols
            for (let i = 0; i < size; i++) {
                let row = [], col = [];
                for (let j = 0; j < size; j++) {
                    row.push(i * size + j);
                    col.push(j * size + i);
                }
                lines.push(row);
                lines.push(col);
            }
            // Diagonals
            let d1 = [], d2 = [];
            for (let i = 0; i < size; i++) {
                d1.push(i * size + i);
                d2.push(i * size + (size - 1 - i));
            }
            lines.push(d1);
            lines.push(d2);

            lines.forEach(indices => {
                const matchCount = indices.filter(idx => board[idx].isMatched).length;
                if (matchCount > maxLineCount) maxLineCount = matchCount;
                if (matchCount === size) {
                    hasWin = true;
                    indices.forEach(idx => winningIndices.add(idx));
                }
            });

            return { hasWin, winningIndices: Array.from(winningIndices), maxLineCount };
        };

        // --- ‰∏ªÁ®ãÂºèÂÖÉ‰ª∂ ---
        function MahjongBingo() {
            const [board, setBoard] = useState([]);
            const [deck, setDeck] = useState([]); 
            const [gameState, setGameState] = useState('idle');
            const [message, setMessage] = useState("Ë´ãÊåâÈñãÂßãÈÅäÊà≤");
            const [drawHistory, setDrawHistory] = useState([]);
            const [isPickingPage, setIsPickingPage] = useState(false);
            
            useEffect(() => {
                const dummyTiles = getUniqueGameTiles().map((type, i) => ({
                    id: `cell-${i}`, type, isMatched: false, isWinningLine: false
                }));
                setBoard(dummyTiles);
            }, []);

            useEffect(() => {
                if (gameState === 'picking' || gameState === 'picking_extra') {
                    setIsPickingPage(true);
                } else {
                    setIsPickingPage(false);
                }
            }, [gameState]);

            const startGame = () => {
                const gameTiles = getUniqueGameTiles();
                const newBoard = gameTiles.map((type, index) => ({
                    id: `cell-${index}`,
                    type: type,
                    isMatched: false,
                    isWinningLine: false
                }));

                const newDeckTiles = [...gameTiles];
                for (let i = newDeckTiles.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newDeckTiles[i], newDeckTiles[j]] = [newDeckTiles[j], newDeckTiles[i]];
                }

                const initialDeck = newDeckTiles.map((type, i) => ({
                    id: `deck-${i}`,
                    type: type,
                    isPicked: false
                }));

                setBoard(newBoard);
                setDeck(initialDeck);
                setDrawHistory([]);
                setGameState('picking');
                setMessage(`Ë´ãÊë∏ ${INITIAL_DRAW_COUNT} ÂºµÁâå`);
            };

            const handleManualPick = (deckIndex) => {
                if (gameState !== 'picking' && gameState !== 'picking_extra') return;
                
                const tile = deck[deckIndex];
                if (tile.isPicked) return; 

                const newDeck = [...deck];
                newDeck[deckIndex] = { ...tile, isPicked: true };
                setDeck(newDeck);

                const newHandTile = { id: `draw-${Date.now()}`, type: tile.type };
                const newHistory = [...drawHistory, newHandTile];
                setDrawHistory(newHistory);

                const updatedBoard = [...board];
                const matchIndex = updatedBoard.findIndex(t => t.type === tile.type);
                if (matchIndex !== -1) {
                    updatedBoard[matchIndex] = { ...updatedBoard[matchIndex], isMatched: true };
                }
                setBoard(updatedBoard);

                const count = newHistory.length;
                const isInitialPhase = gameState === 'picking';
                const target = isInitialPhase ? INITIAL_DRAW_COUNT : (INITIAL_DRAW_COUNT + EXTRA_DRAW_COUNT);

                if (count < target) {
                    setMessage(isInitialPhase ? `ÈÇÑÈúÄÊë∏ ${target - count} Âºµ` : `ÈÇÑÈúÄÊë∏ ${target - count} Âºµ`);
                } else {
                    setTimeout(() => {
                        const result = checkWin(updatedBoard);
                        if (result.hasWin) {
                            handleWin(updatedBoard, result, count);
                        } else {
                            if (isInitialPhase) {
                                if (result.maxLineCount >= 5) {
                                    setGameState('listening_prompt');
                                    setMessage("ËÅΩÁâå‰∫ÜÔºÅÊúâÊ©üÊúÉË£ú 3 ÂºµÔºÅ");
                                } else {
                                    setGameState('gameover');
                                    setMessage("ÂèØÊÉúÔºåÈÄôÊ¨°ÈÅãÊ∞£‰∏çÂ•ΩÔºÅ");
                                }
                            } else {
                                setGameState('gameover');
                                setMessage("Ë£úÁâåÁµêÊùüÔºåÂ∑Æ‰∏ÄÈªûÈªûÔºÅ");
                            }
                        }
                    }, 300);
                }
            };

            const handleWin = (finalBoard, result, count) => {
                const winBoard = finalBoard.map((t, idx) => ({
                    ...t,
                    isWinningLine: result.winningIndices.includes(idx)
                }));
                setBoard(winBoard);
                setGameState('win');
                setMessage(`ÊÅ≠ÂñúË≥ìÊûúÔºÅ(ÂÖ±Êäì ${count} Âºµ)`);
            };

            const startExtraDraw = () => {
                setGameState('picking_extra');
                setMessage("Ë´ãÂÜçÊë∏ 3 ÂºµÁâåÔºÅ");
            };

            const PickingPage = () => {
                const isInitial = gameState === 'picking';
                const totalNeeded = isInitial ? INITIAL_DRAW_COUNT : EXTRA_DRAW_COUNT;
                const currentCount = isInitial ? drawHistory.length : (drawHistory.length - INITIAL_DRAW_COUNT);
                const remaining = totalNeeded - currentCount;

                return (
                    <div className="w-full h-full flex flex-col bg-slate-900">
                        <div className="p-4 bg-emerald-800 text-white shadow-lg shrink-0">
                            <h2 className="text-2xl font-bold text-center mb-1 flex items-center justify-center gap-2">
                                <GripHorizontalIcon className="w-6 h-6" />
                                {isInitial ? 'Á¨¨‰∏ÄÈöéÊÆµÊë∏Áâå' : 'ËÅΩÁâåË£úÊë∏ÈöéÊÆµ'}
                            </h2>
                            <p className="text-center text-emerald-200 text-lg font-mono">
                                ÁõÆÊ®ô: {totalNeeded} Âºµ | ÈÇÑÈúÄ: <span className="text-yellow-300 font-bold text-2xl">{remaining}</span> Âºµ
                            </p>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 flex items-center justify-center bg-amber-900/30">
                            <div className="grid grid-cols-6 gap-2 sm:gap-3 max-w-2xl w-full">
                                {deck.map((tile, idx) => {
                                    if (tile.isPicked) {
                                        return (
                                            <div key={tile.id} className="aspect-[3/4] rounded-lg border-2 border-white/20 bg-black/20 flex items-center justify-center opacity-50">
                                                <span className={`text-2xl ${getTileColor(tile.type)} opacity-50`}>{TILES[tile.type]}</span>
                                            </div>
                                        );
                                    }
                                    return (
                                        <button
                                            key={tile.id}
                                            onClick={() => handleManualPick(idx)}
                                            className="aspect-[3/4] bg-gradient-to-br from-emerald-600 to-emerald-800 rounded-lg border-b-4 border-r-2 border-emerald-950 shadow-xl hover:brightness-110 active:translate-y-1 active:border-b-0 transition-all flex items-center justify-center group relative overflow-hidden"
                                        >
                                            <div className="w-[80%] h-[80%] border-2 border-emerald-400/30 rounded opacity-50"></div>
                                            <div className="absolute inset-0 bg-white/10 -translate-x-full group-hover:translate-x-full transition-transform duration-500 skew-x-12"></div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            };

            const BoardPage = () => {
                return (
                    <div className="w-full h-full flex flex-col bg-slate-800">
                        <div className="bg-gradient-to-r from-red-600 to-red-800 p-3 shadow-lg z-10 flex justify-between items-center border-b-4 border-yellow-500 shrink-0">
                            <div className="flex items-center gap-2">
                                <GiftIcon className="text-yellow-300 w-6 h-6 animate-bounce" />
                                <h1 className="text-2xl font-black text-white tracking-widest drop-shadow-md">
                                    Â§úÂ∏ÇÈ∫ªÂ∞áË≥ìÊûú
                                </h1>
                            </div>
                            <div className="text-yellow-200 font-bold text-sm bg-black/30 px-3 py-1 rounded-full">
                                {gameState === 'idle' ? 'Ê∫ñÂÇôÈñãÂßã' : 'ÈñãÁçéÁµêÊûú'}
                            </div>
                        </div>

                        <div className="bg-black/40 text-center py-2 backdrop-blur-sm shrink-0">
                            <p className={`text-xl font-bold ${gameState === 'win' ? 'text-yellow-400 animate-pulse' : 'text-white'}`}>
                                {message}
                            </p>
                        </div>

                        <div className="flex-1 p-4 bg-green-900 relative flex items-center justify-center min-h-0">
                            <div className="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/felt.png')]"></div>
                            <div className="grid grid-cols-6 gap-1 md:gap-2 aspect-square h-full max-h-[50vh] w-full max-w-[50vh] relative z-10">
                                {board.map((tile, i) => (
                                    <div 
                                        key={tile.id} 
                                        className={`
                                            relative bg-slate-200 rounded flex items-center justify-center
                                            border-b-[3px] border-r-[1px] border-slate-400 shadow-sm
                                            transition-all duration-200
                                            ${tile.isMatched ? 'bg-yellow-200 border-yellow-500 brightness-110' : ''}
                                            ${tile.isWinningLine ? 'animate-pulse bg-red-200 border-red-500 ring-2 ring-red-400 z-10' : ''}
                                        `}
                                    >
                                        <span className={`text-2xl md:text-3xl lg:text-4xl ${getTileColor(tile.type)}`}>
                                            {TILES[tile.type]}
                                        </span>
                                        {tile.isMatched && (
                                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                                <div className="w-8 h-8 md:w-10 md:h-10 rounded-full border-4 border-red-600/60" />
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="bg-slate-800 border-t-4 border-slate-700 p-4 shrink-0">
                            <div className="mb-4">
                                <div className="text-slate-400 text-xs font-bold mb-2">Â∑≤Êë∏ÁöÑÁâå ({drawHistory.length}):</div>
                                <div className="h-10 flex gap-1 overflow-x-auto scrollbar-hide">
                                    {drawHistory.map((tile) => (
                                        <div key={tile.id} className="h-full aspect-[3/4] bg-slate-200 rounded flex items-center justify-center border-b border-slate-400 shrink-0">
                                            <span className={`text-lg ${getTileColor(tile.type)}`}>{TILES[tile.type]}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="flex items-center justify-center">
                                {(gameState === 'idle' || gameState === 'gameover' || gameState === 'win') && (
                                    <button 
                                        onClick={startGame}
                                        className="w-full max-w-sm bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl shadow-xl border-b-4 border-green-800 active:border-b-0 active:translate-y-1 text-xl flex items-center justify-center gap-2 animate-pulse"
                                    >
                                        <PlayIcon className="w-6 h-6" />
                                        ÈñãÂßãÊñ∞Â±Ä
                                    </button>
                                )}

                                {gameState === 'listening_prompt' && (
                                    <button 
                                        onClick={startExtraDraw}
                                        className="w-full max-w-sm bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded-xl shadow-xl border-b-4 border-yellow-800 active:border-b-0 active:translate-y-1 text-xl flex items-center justify-center gap-2 animate-bounce"
                                    >
                                        <AlertCircleIcon className="w-6 h-6" />
                                        ËÅΩÁâåË£úÊë∏ (3Âºµ)
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="relative w-full h-screen max-w-md md:max-w-2xl bg-slate-800 shadow-2xl overflow-hidden flex flex-col mx-auto">
                    {isPickingPage ? <PickingPage /> : <BoardPage />}
                </div>
            );
        }

        // --- ÂïüÂãï React ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MahjongBingo />);
    </script>
</body>
</html>